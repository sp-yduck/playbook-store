- hosts: k8s_master
  tasks:
  - name: swapoff
    include_tasks: ./task/swap-off.yaml

  - name: install-containerd
    include_tasks: ./task/install-containerd.yaml

  - name: install kubeadm,kubelet,kubectl
    include_tasks: ./task/install-kubeadm-kubelet-kubectl.yaml

  - name: kubeadm reset
    shell: kubeadm reset -f
    ignore_errors: yes

  - name: kubeadm init
    include_tasks: ./task/kubeadm-init.yaml

  - name: mkdir /root/.kube
    file:
      path: /root/.kube
      state: directory

  - name: prepare /root/.kube/config
    shell: cp /etc/kubernetes/admin.conf /root/.kube/config

  # TO DO : idempotency
  - name: edit .bashrc
    shell: echo 'alias k=kubectl' >> /root/.bashrc && echo 'export KUBECONFIG=/root/.kube/config' >> /root/.bashrc && source /root/.bashrc

- hosts: k8s_master
  tasks:
  - name: install calico
    include_tasks: ./task/install-calico.yaml