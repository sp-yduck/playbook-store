- name: create containerd.conf
  shell: |
    cat > /etc/modules-load.d/containerd.conf <<EOF
    overlay
    br_netfilter
    EOF
  register: result

- name: load kernel module
  shell: modprobe overlay && modprobe br_netfilter

- name: create kernel parameter config
  shell: |
    cat > /etc/sysctl.d/99-kubernetes-cri.conf <<EOF
    net.bridge.bridge-nf-call-iptables  = 1
    net.ipv4.ip_forward                 = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    EOF

- name: check by sysctl
  shell: sysctl --system

- name: install yum-utils, device-mapper-persistent-data, lvm2
  yum:
    name: "{{ packages }}"
  vars:
    packages:
    - yum-utils
    - device-mapper-persistent-data
    - lvm2

- name: add docker-ce repo
  shell: yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

- name: install containerd.io
  yum:
    name: containerd.io

- name: mkdir -p /etc/containerd
  file:
    path: "/etc/containerd"
    state: directory

- name: configure containerd
  shell: containerd config default | tee /etc/containerd/config.toml

- name: systemctl enable/restart containerd
  systemd:
    name: containerd
    enabled: yes
    state: restarted