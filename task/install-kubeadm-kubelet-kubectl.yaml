- name: install cni plugins
  vars:
    cni_version: v1.1.1
    arch: amd64
  shell: 'curl -L "https://github.com/containernetworking/plugins/releases/download/{{ cni_version }}/cni-plugins-linux-{{ arch }}-{{ cni_version }}.tgz" | sudo tar -C "/opt/cni/bin" -xz'

- name: mkdir for crictl
  file:
    path: "/usr/local/bin"
    state: directory

- name: install crictl
  vars:
    crictl_version: v1.25.0
    arch: amd64
  shell: 'curl -L "https://github.com/kubernetes-sigs/cri-tools/releases/download/{{ crictl_version }}/crictl-{{ crictl_version }}-linux-{{ arch }}.tar.gz" | sudo tar -C "/usr/local/bin" -xz'

- name: set selinux to permissive
  selinux:
    state: permissive
    policy: targeted
    configfile: /etc/selinux/config

- name: get stable release
  shell: curl -sSL https://dl.k8s.io/release/stable.txt
  register: release

- name: download kubeadm
  vars:
    arch: amd64
  shell:
    cmd: "curl -L --remote-name-all https://dl.k8s.io/release/{{ release.stdout }}/bin/linux/{{ arch }}/kubeadm"
    chdir: "/usr/local/bin"

- name: download kubelet
  vars:
    arch: amd64
  get_url:
    url: "https://dl.k8s.io/release/{{ release.stdout }}/bin/linux/{{ arch }}/kubelet"
    dest: "/usr/local/bin/kubelet"
    mode: +x

- name: download kubelet.service
  vars:
    release_version: v0.4.0
  shell:
    cmd: "curl -sSL 'https://raw.githubusercontent.com/kubernetes/release/{{ release_version }}/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service' | sed 's:/usr/bin:/usr/local/bin:g' | sudo tee /etc/systemd/system/kubelet.service"
    chdir: "/usr/local/bin/"

- name: stop kubelet.service
  systemd:
    name: kubelet
    state: stopped

- name: mkdir for kubelet.service.d
  file:
    path: /etc/systemd/system/kubelet.service.d
    state: directory

- name: download kubeadm.conf
  vars:
    release_version: v0.4.0
  shell:
    cmd: "curl -sSL 'https://raw.githubusercontent.com/kubernetes/release/{{ release_version }}/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf' | sed 's:/usr/bin:/usr/local/bin:g' | sudo tee /etc/systemd/system/kubelet.service.d/10-kubeadm.conf"
    chdir: "/usr/local/bin"

- name: chmod kubeadm.conf
  file:
    path: /etc/kubernetes/admin.conf
    mode: +x

- name: chmod kubeadm
  file:
    path: "/usr/local/bin/kubeadm"
    mode: +x

- name: install kubectl
  get_url:
    url: "https://dl.k8s.io/release/{{ release.stdout }}/bin/linux/amd64/kubectl"
    dest: "/usr/local/bin/kubectl"
    mode: +x

- name: install socat,conntrack
  yum:
    name: "{{ packages }}"
  vars:
    packages:
    - socat
    - conntrack

- name: systemctl enable kubelet
  systemd:
    name: kubelet
    state: started
    enabled: yes
    daemon_reload: yes